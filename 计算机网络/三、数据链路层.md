# 数据链路层

## 一、知识总结

#### 1、==数据链路层的几个共同==

- **数据链路和帧**
  - **链路**：是从一个节点到**相邻节点**的一段物理线路（有线或无线），中间没有任何的其他交换节点。链路只是一条路径的组成部分。
  - **数据链路**：将一些必要的控制数据传输的**通信协议**加到链路上，就构成了数据链路。一般使用**网络适配器**来实现这些协议。
  - 早期的数据通信协议叫做**规程**，因此在数据链路层，协议和规程是同义词。
  - **帧**：它是数据链路层的**协议数据单元**。
    - 数据链路层把网络层交下来的数据构成**帧**发送到链路上，反过来就是把接收到的帧中的数据取出并交给网络层。
    - 数据链路层不必考虑物理层的细节。就好像是沿着两个数据链路层之间的水平方向把帧直接发送给对方。
- **三个基本问题**
  - **封装成帧**：就是在网络层交下来的数据的前后**分别添加首部和尾部**，形成帧。
    - 首部和尾部的一个重要作用就是**帧定界（确定帧的界限）**。此外，首部和尾部还包括许多必要的控制信息。
    - 发送帧时，是从**首部进行发送的**。不同的数据链路层协议都对帧首部和尾部的格式有明确的规定。
    - 每一种数据链路层协议都规定了所能传输的帧的**数据部分长度上限——最大传输单元MTU**。
    - 当数据是ASCII码文本文件时，帧定界可以使用特殊的**帧定界符**。控制字符**SOH**放在帧的最前面，表示帧的开始；控制字符**EOT**放在帧的最后，表示帧的结束。
    - 当接收端收到不完整的帧时会直接丢弃。
  - **透明传输**：
    - 当传送的帧是由ASCII码组成的文本文件时，其**数据部分**不会出现SOH、EOT这样的控制字符，将这样的帧传输出去，就叫做**透明传输**。
    - 当数据部分是非ASCII码的文件时，就有可能出现和控制字符相同的二进制码，导致**错误的找到帧的边界**。
    - 想要使**数据中**可能出现的控制字符SOH和EOT不被解释为控制字符，发送端就需要在数据中的SOH或EOT前加上**转义字符ESC**，如果转义字符也出现在数据中，则在其前面也加上转义字符。这种方法叫做**字节填充或字符填充**。
  - **差错检测**
    - **比特差错**：比特在传输过程中会出现差错，1可能变成0，0可能变成1，这就叫做比特差错。
    - **误码率BER（Bit Error Rate）**：BER = (错误传输的比特) / (传输比特的总数)；
    - **循环冗余检验CRC**：它是一种差错检测技术
      - **冗余码的发送**：
        - **构造被除数**：将待发送数据后面添加**生成多项式**[^1]最高次数个0。
        - **构造除数**：将生成多项式的**各项系数构成的比特串**作为除数。
        - 将两者做**二进制模2运算[^2]**，相当于对应位进行逻辑异或运算。
        - **检查余数**：余数的位数要与生成多项式的最高次数相同，检查后将余数加到数据后。
      - **冗余码的校验**：
        - **构造被除数**：将接收到的数据作为被除数。
        - **构造除数**：将生成多项式的系数作为除数。
        - 做二进制模2除法。
        - **检查余数**：余数为0，则无误码，否则有误码。
      - CRC只能做到对帧的**无差错接受[^3]**，有错误的帧都被丢弃，所以基本上**凡是接收端数据链路层接受的帧均无差错**。
    - 对于通信质量良好的**有线传输链路**，数据链路层协议不使用**确认和重传机制[^4]**,即不需要进行**可靠传输**。
    - 对于通信质量较差的**无线传输链路**，数据链路层协议要使用**确认和重传机制**,即需要进行**可靠传输**。

#### 2、==点对点协议PPP==

- **PPP协议的特点**
  - ppp协议就是用户**计算机和ISP通信时**所使用的数据链路层协议。
  - **PPP协议应满足的需求**
    - **简单**：因为它提供的是**不可靠的数据报服务**，所以简单是**首要的需求**。简单的设计使不同厂商在协议的不同实现上的**互操作性提高了**。
    - **封装成帧**：PPP协议使用特殊的字符作为**帧定界符**，可以表示一个帧的开始位置和结束位置。
    - **透明性**：PPP协议必须保证数据传输的透明性。
    - **多种网络层协议**：PPP协议必须能够**在同一条物理链路上同时支持多种网络层协议（比如IP和IPX等）**的运行。
    - **多种类型链路**：PPP必须能够在**多种类型的链路上运行**。
    - **差错检测**：PPP协议必须能够对接收端收到的帧进行检测，并且**立即丢弃有差错的帧**。
    - **检测链接状态**：PPP协议必须能够**及时（在几分钟内）自动检测出链路是否处于正常工作状态中**。
    - **最大传输单元**：PPP协议对每一种点对点链路设置的**最大传输单元MTU**的标准默认值，是帧可以载荷的**数据部分**的最大长度。这样做是为了促进各种实现之间的互操作性。
    - **网络层地址协商**：PPP协议必须提供一种机制使通信的两个网络层的实体**能够通过协商知道或配置彼此的网络层地址**。
    - **数据压缩协商**：PPP协议必须提供一种机制协商使用数据压缩算法。
  - **PPP协议的组成**：有三个组成部分
    - 一个将IP数据报封装到串行链路上的方法。
    - 一个用来建立、配置和测试链路连接的**链路控制协议LCP**。
    - 一套**网络控制协议NCP**，其中每一个协议支持不同的网络层协议。
- **PPP协议的帧格式**
  - **各字段的意义**：PPP帧分为首部的四个字段和尾部的两个字段
    - 首部的第一个字段和尾部的第二个字段都是**标志字段F(Flag)**，规定为0x7E，标志一个帧的开始与结束。因此**标志字段就是PPP帧的定界符**。
    - 首部的第二个控制字段A规定为0xFF，第三个控制字段C规定为0x03，这两个字段屁用没有，不用管他。
    - 首部的第四个字段是**两字节的协议字段**，若为0x0021时，就表示数据部分为IP数据报；若为0xC021，表示为PPP链路控制协议LCP；若为0x8021，则表示网络层的控制数据。
    - 信息字段的长度是可变的，不超过1500字。
    - 尾部的第一个字段是使用CRC的帧检测序列FCS。
  - **字节填充**：当PPP使用**异步传输[^5]**时，它把转义字符定义为0x7D，并使用字节填充来实现透明传输
    - 把信息字段中出现的每一个0x7E字节转变为2字节序列（0x7D, 0x5E）
    - 若信息字段中出现0x7D字节（和转义字节一样的字节），则在该字节后添加0x5D。
    - 若信息字段出现了**ASCII码的控制字符[^6]**时，则在该字符前面·加上0x7D字节。
    - 接受端要把填充的转义字符去掉才能得到真正的信息。
  - **零比特填充**：当PPP使用**同步传输[^7]**，使用比特填充来实现透明传输
    - 因为0x7D的二进制序列为**01111110**，所以发送端只要在信息字段发现有连续的5个1，就立即填充一个0，这样就不会在信息字段出现6个连续的1了。
    - 接收端接收到这个帧时，只需要找到标志字段F，然后把信息字段出现的五个1后面的一个0去掉即可。
- **PPP协议的工作状态**
  - **链路建立**：目的是建立链路层的LCP连接
    - 用户个人电脑通过调制解调器呼叫路由器，路由器检测到其发出的载波信号。在双方建立了物理层连接后，PPP就进入了**链路建立状态**。
    - 此时LCP开始协商一些**配置选项**，即发送LCP的**配置请求帧**。这是PPP帧，其协议字段置为LCP对应的代码，信息字段包含特定的配置请求。
    - 链路接收端收到配置请求帧后，根据情况可发送以下**响应**中的一种：
      - **配置确认帧**：所有的选项都接受。
      - **配置否认帧**：所有的选项都理解，但是不能接受。
      - **配置拒绝帧**：选项中有的选项无法识别或不能接受，需要协商。
    - LCP配置选项包括链路上的最大帧长、所使用的鉴别协议的规约、以及不使用PPP帧中的地址和控制字段。
    - 在协商结束后就建立了LCP链路，开始进入鉴别状态。
  - **鉴别**：
    - 在**鉴别状态**，只允许传送LCP协议、鉴别协议以及检测链路质量的分组。
    - 若使用**口令鉴别协议PAP**，发起通信的一方需要发送**身份标识符和口令**。系统允许用户尝试若干次。如果需要更好的安全性，则可使用更加复杂的**口令握手鉴别协议CHAP**。
    - 若鉴别身份失败，则转到**链路终止**的状态。若鉴别成功，则进入网络层协议状态。
  - **网络层协议**：
    - 在此状态下，PPP链路两端的NCP根据网络层的不同协议互相交换网络层特定的**网络控制分组**。
    - 如果在PPP链路上运行的是IP协议，就需要将NCP中支持IP的协议的**IP控制协议IPCP**的分组封装成PPP帧，然后对PPP链路的每一端**配置IP协议模块（比如分配IP地址）**。
    - 当网络层配置完毕后，就进入了**链路打开状态**。
  - **链路打开**：在此状态下的两个PPP端点可以向彼此发送分组。两个端点还可以发送**回送请求LCP分组和回送回答LCP分组**，以检查链路的状态。
  - **链路终止**：
    - 数据传输结束后，可由链路的一端发送**终止请求LCP分组**请求终止链路连接，在收到对方发来的**终止确认LCP分组**后，转到链路终止状态。
    - 如果链路出现故障，也会从**链路打开状态**转到链路终止状态。当调制解调器的载波停止后，则回到**链路禁止状态**，就是物理层连接断开。
  - 由此可见，PPP协议**不是纯粹的数据链路层协议，它还包含了物理层和网络层的协议**。

#### 3、==使用广播信道的数据链路层==

- **局域网的数据链路层**
  - 局域网的主要特点是：**网络为一个单位所拥有，且地理范围和站点数目均有限**。
  - 局域网的优点：
    - **具有广播功能**，从一个站点可以方便地访问全网。局域网的主机可共享连接在局域网上的各种硬件和软件资源。
    - **便于系统的扩展和逐渐的演变**，各设备的位置可灵活调整和改变。
    - 提高了系统的可靠性、可用性和生存性。
  - **按网络拓扑进行分类的局域网**
    - **总线型局域网**：
      - 它是一种基于**共享传输介质**的局域网拓扑结构，所有计算机都连接到**同一条**传输线（也称为总线）上。
      - 当一个计算机发送数据时，数据会在总线上传输，所有其他计算机都可以接收到这些数据，但**只有目标计算机会处理这些数据**。
      - 它的优点是**简单易实现**，但缺点是当网络负载较高时可能会出现**数据冲突和性能下降**。
    - **星型局域网**：
      - 它是一种**以集线器或交换机为中心**的局域网拓扑结构，所有计算机都通过独立的电缆连接到集线器或交换机上。
      - 当一个计算机发送数据时，数据会通过集线器或交换机发送到目标计算机，其他计算机不会接收到这些数据。
      - 它的优点是**易于维护和扩展**，且可以提供更好的性能和可靠性。
  - **共享通信媒体资源技术**
    - **静态划分信道**：比如频分复用、时分复用和码分复用等。用户只要分配到了信道就不会和其他用户发生冲突。但他代价较高，不适用于局域网。
    - **动态媒体接入控制**：又称**多点接入**，其特点是**信道并非在用户通信时固定分配给用户**
      - **随机接入**：用户在接入网络或系统时**没有特定的顺序或限制**，他们可以随时随地进行接入。但是多个用户同时发送消息可能会导致网络拥堵和安全隐患，必须有解决冲突的网络协议。
      - **受控接入**：用户在接入网络或系统时**需要经过授权或验证**，以确保其身份和权限符合要求。受控接入的优点是安全性高，但缺点是可能会增加用户的接入时间和步骤。
  - **网卡适配器的作用**
    - 网卡适配也称为**网络接口卡NIC**（Network Interface Card，NIC），是一种用于连接计算机与局域网或互联网的硬件设备。它通常安装在计算机的主板上。
    - 它将计算机产生的数据转换成网络可以传输的信号，并将接收到的网络信号转换成计算机可以理解的数据。
    - 网卡适配器包括**有线网卡和无线网卡**。有线网卡通过**以太网线**连接计算机与局域网，而无线网卡则通过Wi-Fi连接计算机与无线网络。
    - **网卡适配器是计算机与网络之间的桥梁**，它使得计算机能够与局域网或互联网进行通信和数据传输，是计算机网络中不可或缺的组件。
- **CSMA/CD协议**
- **使用集线器的星型拓扑**
- **以太网的信道利用率**
- **以太网的MAC层**

#### 4、==扩展的以太网==

- **在物理层扩展以太网**
- **在数据链路层扩展以太网**
- **虚拟局域网**

#### 5、==高速以太网==

- **100BASE-T以太网**
- **吉比特以太网**
- **10吉比特以太网和更快的以太网**
- **使用以太网进行宽带接入**

## 二、习题解答

1. 将一些必要的控制数据传输的**通信协议**加到链路上，就构成了数据链路。“链路接通了”是指物理层面的连接已经建立，“数据链路接通了”是指在物理层面的基础上，数据链路层也已经建立，可以进行数据传输。
2. 包括**封装成帧、透明传输和差错检测**；优点：能够进行差错检测和数据纠正，具有重传机制；缺点：链路设计复杂，可能会增加网络的负担和延迟，还会造成各方面的开销。
3. 实现计算机与网络之间的连接和通信，使计算机能够参与到网络中的数据交换和通信活动中；在数据链路层和网络层。
4. 解决这些问题可以确保数据链路层的可靠传输和数据的完整性，从而保障整个网络的正常运行。
5. 无法判断一个帧的开始与结束。
6. 简单、帧定界、透明传输、差错检测、支持各种网络层协议、能够检测链路状态；点对点连接、简单性、可靠性；适用于点对点连接和宽带接入；因为PPP协议只会丢弃有比特差错的帧，不会将其改正。
7. P(X)的最高项次数为4，则余数n = 1101011011 0000 % 10011 = 1110;两种都能检测；没有变成可靠传输。
8. P(X)的最高项次数为3，则余数n = 101110 000 % 1001 = 011。
9. 7E FE 27 7D 7D 65 7E
10. 011011111011111000; 000111011111 11111 110.
11. 在没有信号损坏或干扰的情况下是透明传输，否则不是；电子邮件类似于前面。
12. 链路静止、链路打开、鉴别、网络层协议、链路打开、链路终止

[^1]:类似于P(X) = X^3^ + X^2^ + 1
[^2]:用模2运算进行加法时不进位，例如，1111 + 1010 = 0101
[^3]: 凡是接收端接受的帧，我们都能以非常接近于1的概率认为这些帧在传输过程中没有出现差错
[^4]: 收到正确的帧就要向发送端发送确认，如果发送端在一定时间内没有收到对方的确认，就认为出现了差错，因而就要进行重传
[^5]: 逐个字符的传送
[^6]: 数值小于0x20的互换字符
[^7]: 一连串的比特持续传送